{% extends "base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>

<style>
    li .list-group-item {
        padding: 3;
    }
    .doughnut-chart-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
    }
    .doughnut-chart-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 65px;
        font-weight: bold;
    }
</style>

<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-2">
                    <h class="display-6">{{ learning_block.name }}</h>
                    <h3 style="color: #1F6F9A; margin-bottom: 0;">
                        {{ block_words|length }} words
                    </h>
                    {% if user.is_authenticated %}
                        <h6 style="color: green; margin-left: 35px;">
                            {{ num_learned_words }} learned
                        </h6>
                    {% endif %}

                    <!-- Button to quiz_learn -->
                    <form method="POST" action="{% url 'quiz_learn' %}">
                        {% csrf_token %}
                        <input type="hidden" value="{{ learning_block.slug }}" name="learning_block">
                        {% if not user.is_authenticated %}
                            <span class="tt" title="Sign in to save your progress">
                                <input type='submit' class="btn btn-primary" value="Learn Words" style="margin-top: 10px;" disabled> 
                            </span>
                        {% elif num_learned_words == block_words|length %}
                            <span class="tt" title="You have learned all words in this block!">
                                <input type='submit' class="btn btn-outline-secondary" value="Learn Words" style="margin-top: 10px;" disabled> 
                            </span>
                        {% else %}
                            <input type='submit' class="btn btn-primary" value="Learn Words" style="margin-top: 10px;"> 
                        {% endif %}
                    </form>
                    
                    <!-- Button to quiz_review -->
                    <form method="POST" action="{% url 'quiz_review' %}">
                        {% csrf_token %}
                        <input type="hidden" value="{{ learning_block.slug }}" name="learning_block">
                        <input type='submit' class="btn btn-success" value="Review" style="margin-top: 10px; color: white;" {% if num_learned_words == 0 or not user.is_authenticated %}disabled{% endif %}>
                    </form>

                    <!-- Button to quiz_multi_choice -->
                    <form method="POST" action="{% url 'quiz_multi_choice' %}">
                        {% csrf_token %}
                        <input type="hidden" value="{{ learning_block.slug }}" name="learning_block">
                        <input type='submit' class="btn btn-outline-secondary" value="Start Quiz" style="margin-top: 10px;">
                    </form>
                    
                </div>
                <div class="col-2 text-center">
                        <!-- Mastery level block -->
                        <nobr>
                            <a href="{% url 'user_block_detail' learning_block.slug %}" style="width: fit-content;">Block Mastery Level</a> {{ block_mastery_level_pct|floatformat:1 }}%
                            <span class="tt" title="Every time you answer a question correctly, you get a point. Incorrect answers decrease points. The more points you have, the higher your mastery level is." style="margin-right: 10px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                            </span>
                        </nobr>
                        
                        <!-- Doughnut chart -->
                        <div id="ml-doughnut" class="chart doughnut-chart-container">
                            {{ bml_fractional_part|json_script:"bml-doughnut-fractional" }}
                            <canvas id="doughnut" style="max-width: 200px; max-height: 200px;">erter</canvas>
                            <p class="doughnut-chart-text">{{ bml_whole_part|floatformat:0 }}</p>
                        </div>
                </div>

                <div class="col-8">
                    <div id="ml-chart" class="chart">
                        {{ ml_chart|json_script:"ml-chart-data" }}
                        <canvas id="chart" style="max-width: 600px; max-height: 200px;"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="row justify-content-between">
            <div class="col-lg-2 col-sm-12">
            <!-- List of words block -->
            <div class="card" style="width: 18rem; margin-top: 10px;">
                <div class="card-header">List of words</div>
                <ol class="list-group list-group-flush" style="padding: 7px;">
                    {% for word in block_words %}
                        <li style="margin-left: 20px;">
                            <div class="row">
                                <div class="col">{{ word.name }}</div>
                                <div class="col">{{ word.translation }}</div>
                            </div>
                        </li>
                    {% endfor %}
                </ol>
            </div>
        </div>

        <div class="col-lg-9 col-sm-12">
            <!-- Theory block -->
            <div class="card" style="width: 100%; margin-top: 10px;">
                <div class="card-header">Theory</div>
                <div class="card-body">
                    <p class="card-text" style="font-size: 24px;">{{ learning_block.theory|safe }}</p>
                </div>
            </div>
        </div>
    </div>


</div>


<!-- Show block mastery doughnut chart -->
<script>
    let ctx = document.getElementById('doughnut').getContext('2d');
    let bmlDoughnutFractional = JSON.parse(document.getElementById("bml-doughnut-fractional").textContent);
    bmlDoughnutFractional *= 100;

    let doughnutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [bmlDoughnutFractional, 100 - bmlDoughnutFractional],
                backgroundColor: ['#50C878', '#D3D3D3'],
            }],
        },
});
</script>

<!-- Show block mastery chart -->
<script>
    let ctx2 = document.getElementById("chart").getContext("2d");
    const mlChartData = JSON.parse(document.getElementById("ml-chart-data").textContent);

    let chart = new Chart(ctx2, {
    type: "bar",
    data: {
        labels: mlChartData["x"],
        datasets: [
            {
            label: "Number of words",
            backgroundColor: "#79AEC8",
            borderColor: "#417690",
            data: mlChartData["y"]
            }
        ]
    },
    options: {
        scales: {
            x: {
                title: {
                    display: true,
                    text: "Mastery level"
                }
            },
            y: {
                title: {
                    display: true,
                    text: "Number of words"
                }
            }
        }
    }
    });
</script>

{% endblock %}